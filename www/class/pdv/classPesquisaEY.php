<?php
class classPesquisaEY {
		
	private $pin;
        private $ug_id_pdv;
        private $opr_codigo;
        private $erros = array();
        private $lista_pdv_participantes = array(55,65,73,111,123,127,160,168,175,191,212,215,218,220,233,256,267,273,290,349,419,420,427,445,449,452,453,497,499,522,542,550,552,561,569,570,1899,1941,2569,2573,2582,2596,2600,2627,2644,2658,2660,2670,2677,2720,2722,2738,2753,3223,3247,3265,3266,3281,3288,3319,3320,3337,3338,3344,3358,3378,3379,3384,3399,3402,3417,3423,3432,3447,3517,3541,3549,3593,3616,3636,3637,3691,3731,3740,3742,3761,3795,3867,3878,3886,3896,3899,3906,3922,3926,3935,3948,3956,3963,3988,4008,4021,4027,4035,4042,4043,4079,4081,4092,4097,4108,4109,4120,4139,4145,4158,4164,4204,4221,4234,4304,4308,4310,4312,4321,4340,4346,4349,4357,4358,4361,4399,4405,4419,4447,4454,4458,4465,4478,4480,4483,4494,4506,4512,4517,4525,4547,4553,4557,4579,4595,4608,4646,4651,4658,4668,4685,4691,4698,4700,4706,4707,4718,4719,4725,4731,4741,4745,4747,4755,4763,4766,4768,4771,4778,4785,4794,4799,4813,4835,4858,4867,4873,4879,4889,4897,4900,4909,4916,4920,4931,4952,4959,4964,4979,4984,5006,5012,5013,5024,5026,5028,5042,5048,5051,5068,5072,5084,5085,5087,5092,5094,5102,5106,5108,5144,5164,5171,5174,5180,5194,5202,5210,5212,5214,5215,5221,5225,5230,5237,5242,5245,5248,5252,5254,5257,5261,5263,5264,5267,5287,5296,5299,5300,5302,5306,5318,5323,5339,5341,5348,5355,5360,5363,5364,5369,5379,5380,5381,5396,5406,5407,5408,5412,5414,5422,5423,5426,5440,5444,5447,5454,5455,5459,5466,5475,5477,5490,5492,5499,5503,5510,5512,5518,5519,5523,5524,5533,5534,5540,5553,5561,5566,5570,5571,5581,5590,5592,5598,5601,5604,5614,5618,5622,5624,5629,5632,5633,5638,5648,5650,5658,5661,5665,5691,5702,5708,5720,5725,5731,5732,5735,5738,5758,5764,5773,5781,5788,5799,5800,5803,5806,5809,5814,5817,5824,5838,5840,5843,5844,5850,5866,5870,5876,5884,5905,5907,5919,5920,5921,5926,5927,5932,5938,5939,5951,5955,5957,5961,5965,5967,5973,5976,5977,5979,5982,5984,5990,6002,6011,6014,6019,6020,6022,6025,6028,6033,6036,6038,6042,6044,6049,6050,6053,6055,6056,6057,6064,6066,6075,6086,6089,6099,6114,6118,6128,6132,6136,6137,6139,6140,6155,6158,6170,6174,6182,6189,6202,6204,6205,6208,6215,6221,6226,6237,6242,6252,6254,6257,6260,6261,6262,6266,6269,6277,6293,6300,6301,6305,6315,6317,6319,6322,6337,6339,6342,6346,6352,6355,6357,6359,6365,6370,6373,6377,6386,6387,6394,6396,6424,6425,6434,6438,6445,6448,6454,6476,6477,6483,6488,6507,6512,6515,6519,6526,6532,6549,6553,6555,6564,6569,6580,6582,6587,6593,6594,6596,6598,6613,6615,6620,6623,6627,6628,6633,6635,6639,6641,6647,6649,6655,6662,6671,6672,6675,6682,6683,6684,6686,6695,6704,6705,6710,6716,6720,6724,6732,6739,6741,6742,6747,6750,6754,6755,6764,6769,6773,6775,6788,6791,6793,6801,6804,6805,6807,6814,6822,6824,6828,6841,6850,6856,6859,6861,6866,6883,6910,6913,6915,6922,6929,6934,6939,6958,6959,6961,6963,6972,6974,6982,6984,6993,7000,7015,7019,7026,7034,7035,7036,7048,7056,7057,7062,7063,7069,7088,7093,7094,7099,7106,7111,7121,7123,7128,7132,7135,7137,7138,7140,7142,7154,7161,7164,7180,7187,7189,7191,7192,7199,7211,7222,7252,7256,7258,7269,7273,7279,7280,7284,7292,7293,7295,7318,7319,7320,7335,7336,7339,7342,7350,7352,7363,7368,7372,7373,7375,7383,7390,7396,7397,7401,7404,7447,7452,7461,7462,7469,7473,7479,7480,7486,7488,7504,7507,7513,7519,7526,7527,7531,7540,7541,7545,7557,7566,7567,7572,7574,7576,7580,7581,7589,7594,7601,7609,7614,7617,7618,7629,7630,7632,7637,7638,7639,7647,7660,7665,7669,7672,7675,7689,7692,7696,7697,7705,7719,7722,7725,7726,7736,7738,7744,7761,7770,7775,7782,7790,7796,7803,7807,7808,7810,7818,7819,7830,7834,7870,7890,7892,7901,7906,7909,7949,7950,7957,7967,7990,8001,8004,8009,8015,8018,8023,8025,8052,8053,8057,8092,8097,8105,8108,8148,8149,8153,8155,8162,8184,8189,8205,8223,8246,8252,8261,8269,8290,8294,8304,8349,8354,8369,8377,8399,8408,8464,8466,8473,8531,8539,8551,8561,8572,8581,8596,8612,8623,8636,8658,8670,8716,8737,8745,8764,8767,8780,8781,8786,8835,8861,8864,8890,8895,8908,8966,8980,9025,9053,9071,9076,9102,9113,9118,9131,9137,9138,9145,9151,9153,9162,9174,9199,9200,9225,9229,9255,9267,9290,9312,9322,9332,9337,9355,9363,9385,9401,9402,9418,9446,9448,9457,9461,9475,9493,9494,9497,9500,9523,9527,9555,9562,9571,9577,9584,9592,9595,9605,9661,9663,9672,9676,9677,9681,9687,9688,9695,9700,9704,9717,9719,9720,9721,9729,9734,9744,9751,9753,9756,9757,9767,9786,9789,9792,9801,9807,9809,9810,9825,9830,9835,9862,9880,9881,9882,9885,9886,9890,9895,9898,9909,9910,9916,9926,9928,9937,9939,9947,9948,9952,9953,9955,9958,9996,10006,10011,10012,10022,10023,10027,10036,10038,10043,10044,10045,10046,10049,10062,10078,10079,10083,10088,10093,10097,10104,10105,10107,10110,10112,10113,10135,10142,10143,10146,10156,10157,10159,10161,10168,10175,10183,10186,10201,10208,10243,10244,10246,10250,10255,10273,10286,10287,10302,10305,10311,10313,10314,10316,10322,10329,10330,10331,10336,10354,10370,10372,10373,10380,10386,10388,10391,10393,10406,10407,10410,10415,10425,10426,10427,10429,10430,10444,10446,10457,10459,10480,10481,10483,10485,10487,10490,10491,10494,10501,10503,10512,10514,10516,10521,10522,10523,10526,10530,10538,10542,10543,10551,10557,10559,10560,10561,10565,10575,10577,10584,10586,10590,10591,10592,10597,10601,10602,10603,10608,10612,10613,10614,10617,10642,10645,10651,10653,10655,10668,10673,10674,10690,10697,10698,10705,10706,10720,10723,10729,10734,10738,10740,10748,10754,10760,10762,10765,10768,10770,10776,10777,10779,10781,10782,10783,10791,10794,10795,10796,10802,10804,10805,10809,10818,10821,10824,10838,10853,10854,10856,10861,10865,10873,10876,10883,10884,10885,10892,10893,10897,10901,10912,10914,10915,10918,10924,10925,10937,10944,10945,10968,10972,10974,10976,10981,10984,10988,11016,11039,11042,11045,11049,11051,11053,11054,11055,11058,11064,11069,11071,11074,11085,11088,11090,11093,11101,11105,11111,11114,11124,11126,11131,11136,11139,11144,11149,11161,11165,11169,11172,11179,11180,11181,11182,11183,11186,11187,11191,11192,11195,11197,11201,11205,11208,11209,11215,11222,11243,11251,11254,11259,11261,11269,11273,11279,11280,11281,11289,11295,11300,11306,11308,11322,11334,11338,11340,11346,11349,11351,11357,11358,11359,11360,11361,11366,11371,11382,11390,11391,11394,11396,11397,11406,11407,11410,11413,11414,11415,11416,11422,11423,11426,11430,11435,11436,11439,11441,11453,11457,11464,11473,11476,11477,11492,11501,11504,11513,11517,11531,11537,11550,11553,11558,11563,11567,11568,11570,11578,11580,11586,11595,11599,11600,11615,11622,11627,11634,11638,11644,11647,11648,11650,11656,11657,11663,11664,11671,11683,11686,11687,11691,11694,11703,11710,11714,11716,11720,11721,11729,11730,11731,11732,11747,11749,11752,11757,11759,11760,11764,11773,11779,11781,11784,11787,11801,11809,11816,11823,11824,11825,11831,11836,11837,11841,11842,11843,11869,11871,11877,11881,11895,11903,11906,11922,11923,11938,11947,11950,4708,6988);
        private $lista_publishers_participantes = array(90, 13);
        private $pdo;

	public function __construct($pin) {
		$this->setPin(trim($pin));
                
                //Iniciando conexão PDO
                $this->pdo = $con = ConnectionPDO::getConnection();
                $this->pdo = $con->getLink();
                
                //Verificando se ainda não respondeu a pesquisa
                if($this->getAindaPesquisar()) {
                    //Verificando se o PIN existe
                    if($this->getDados()) {
                        //Verificando se o PIN pertence a um Publisher participantes da pesquisa
                        if(in_array($this->getPublisher(), $this->lista_publishers_participantes)) {
                            //Verificando se o PDV NÃo é participante da pesquisa
                            if(!in_array($this->getPDV(), $this->lista_pdv_participantes)) {
                                $this->erros[] = "Este PIN não foi vendido por um Ponto de Venda autorizado para esta ação";
                            }//end if(in_array($this->getPDV(), $this->lista_pdv_participantes))
                        }//end if(in_array($this->getPublisher(), $lista_publishers_participantes))
                        else $this->erros[] = "Este PIN não corresponde a um jogo participante desta ação";
                    }//end if($this->getDados())
                    else $this->erros[] = "Este número de PIN cadastrado não é válido. Por favor, verifique o número do PIN adquirido no Ponto de Venda.";
                }//end if($this->getAindaPesquisar())
                else $this->erros[] = "Você já fez o pré-cadastro para a pesquisa.";
                   
	}//end function __construct()

	private function setPin($pin) {
		$this->pin = $pin;
	}//end function setPin

	public function getPin() {
		return $this->pin;
	}//end function getPin

	private function setPDV($ug_id_pdv) {
		$this->ug_id_pdv = $ug_id_pdv;
	}//end function setPDV

	public function getPDV() {
		return $this->ug_id_pdv;
	}//end function getPDV

	private function setPublisher($opr_codigo) {
		$this->opr_codigo = $opr_codigo;
	}//end function setPublisher

	public function getPublisher() {
		return $this->opr_codigo;
	}//end function getPublisher

	public function getErro() {
		return $this->erros;
	}//end function getErro

	private function getAindaPesquisar() {
		$sql  = "
                    select pin
                    from pesquisa_ernst_young
                    where  pin = :pin;";
                $arrParam = array(':pin'    => $this->getPin());
                
                $rs = $this->pdo->prepare($sql);
                $rs->execute($arrParam);
                $rs_row = $rs->fetch();
                if(!empty($rs_row['pin'])) {
                    return false;
		} else {
                    return true;
		}
	}//end function getAindaPesquisar() 

	private function getDados() {
		$sql  = "
                    select vg_ug_id,vgm_opr_codigo 
                    from pins
                            inner join tb_dist_venda_games_modelo_pins ON (vgmp_pin_codinterno = pin_codinterno)
                            inner join tb_dist_venda_games_modelo ON (vgmp_vgm_id=vgm_id)
                            inner join tb_dist_venda_games ON (vgm_vg_id=vg_id)
                    where  pin_codigo = :pin;";
                $arrParam = array(':pin'    => $this->getPin());
                
                $rs = $this->pdo->prepare($sql);
                $rs->execute($arrParam);
                $rs_row = $rs->fetch();
                if(empty($rs_row['vg_ug_id']) || empty($rs_row['vgm_opr_codigo'])) {
                    return false;
		} else {
			$this->setPDV($rs_row['vg_ug_id']);
                        $this->setPublisher($rs_row['vgm_opr_codigo']);
                        return true;
		}
	}//end function getDados() 


	
	public function salvaPesquisa($params) {

		$sql = "
                    INSERT INTO pesquisa_ernst_young (
                            pin,
                            email,
                            ano_nascimento,
                            comprou_internet,
                            conta_banco,
                            cartao_credito,
                            smart_phone,
                            ug_id_pdv,
                            opr_codigo,
                            sexo,
                            compra_mes
                    )
                    VALUES (
                            :pin,
                            :email,
                            :ano_nascimento,
                            :comprou_internet,
                            :conta_banco,
                            :cartao_credito,
                            :smart_phone,
                            :ug_id_pdv,
                            :opr_codigo,
                            :sexo,
                            :compra_mes
                    );";
                $arrParam = array(
                                ':pin'              => $this->getPin(),
                                ':email'            => $params['email'],
                                ':ano_nascimento'   => $params['ano_nascimento'],
                                ':comprou_internet' => $params['comprou_internet'],
                                ':conta_banco'      => $params['conta_banco'],
                                ':cartao_credito'   => $params['cartao_credito'],
                                ':smart_phone'      => $params['smart_phone'],
                                ':ug_id_pdv'        => $this->getPDV(),
                                ':opr_codigo'       => $this->getPublisher(),
                                ':sexo'             => $params['sexo'],
                                ':compra_mes'       => $params['compra_mes']
                                 );

                $rs = $this->pdo->prepare($sql);
                $rs->execute($arrParam);
                
                if($rs->rowCount() == 1)  return true;
		else {
                    $this->erros[] = "Algum erro aconteceu durante o processamento de sua pesquisa. Por favor, entre em contato com o suporte da E-Prepag e informe o Erro 98456. Obrigado.";
                    return false;
                }
	} //end function salvaPesquisa
	

} //end class classPesquisaEY

?>